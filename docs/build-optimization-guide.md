# è¾¹ç¼˜ç«¯éƒ¨ç½²ç¼–è¯‘ä¼˜åŒ–æŒ‡å—

æœ¬æ–‡æ¡£åŸºäº [Aloxaf's Blog - ä¼˜åŒ– Rust ç¨‹åºç¼–è¯‘ä½“ç§¯](https://www.aloxaf.com/2018/09/reduce_rust_size/) çš„ä¼˜åŒ–æŠ€å·§ï¼Œé’ˆå¯¹è¾¹ç¼˜ç«¯éƒ¨ç½²è¿›è¡Œäº†é…ç½®ä¼˜åŒ–ã€‚

## âœ… å·²åº”ç”¨çš„ä¼˜åŒ–

### 1. Release æ¨¡å¼é…ç½®

åœ¨ workspace æ ¹ç›®å½•çš„ `Cargo.toml` ä¸­é…ç½®äº† `[profile.release]`ï¼š

```toml
[profile.release]
opt-level = 'z'        # æœ€å°äºŒè¿›åˆ¶ä½“ç§¯ä¼˜åŒ–
lto = true             # é“¾æ¥æ—¶ä¼˜åŒ–
codegen-units = 1      # é™åˆ¶å¹¶è¡Œä»£ç ç”Ÿæˆå•å…ƒ
panic = 'abort'        # Panic æ—¶ç«‹åˆ»ç»ˆæ­¢ï¼ˆå‡å°‘ä½“ç§¯ï¼‰
debug = false          # å‡å°‘è°ƒè¯•ä¿¡æ¯
strip = true           # å‡å°‘ç¬¦å·ä¿¡æ¯
```

**æ•ˆæœ**ï¼š
- ä¼˜åŒ–ç­‰çº§ `z`ï¼šä¸“é—¨é’ˆå¯¹ä½“ç§¯ä¼˜åŒ–
- LTOï¼šæ¶ˆé™¤å†—ä½™ä»£ç ï¼Œæ˜¾è‘—å‡å°ä½“ç§¯
- `codegen-units = 1`ï¼šä¾¿äºç¼–è¯‘å™¨è¿›è¡Œå…¨å±€ä¼˜åŒ–
- `panic = 'abort'`ï¼šç¦ç”¨æ ˆå›æº¯ï¼Œå‡å°‘ä½“ç§¯ï¼ˆæ³¨æ„ï¼šä¼šç¦ç”¨ panic æ—¶çš„å †æ ˆä¿¡æ¯ï¼‰

### 2. ä¾èµ– Features ä¼˜åŒ–

å·²ä¼˜åŒ–ä»¥ä¸‹ä¾èµ–çš„ featuresï¼Œåªå¯ç”¨å¿…è¦çš„åŠŸèƒ½ï¼š

#### Tokio
```toml
tokio = { version = "1.0", default-features = false, features = [
    "rt-multi-thread",  # å¤šçº¿ç¨‹è¿è¡Œæ—¶
    "net",              # ç½‘ç»œæ”¯æŒ
    "io-util",          # IO å·¥å…·
    "time",             # æ—¶é—´æ”¯æŒ
    "sync",             # åŒæ­¥åŸè¯­
    "macros",           # å®æ”¯æŒ
] }
```

**ä¼˜åŒ–è¯´æ˜**ï¼š
- ç¦ç”¨ `full` featureï¼Œåªå¯ç”¨å®é™…ä½¿ç”¨çš„åŠŸèƒ½
- å¤§å¹…å‡å°‘ç¼–è¯‘ä½“ç§¯å’Œä¾èµ–

#### Axum
```toml
axum = { version = "0.7", default-features = false, features = ["http1", "http2", "json"] }
```

**ä¼˜åŒ–è¯´æ˜**ï¼š
- åªå¯ç”¨ HTTP/1ã€HTTP/2 å’Œ JSON æ”¯æŒ
- ç¦ç”¨å…¶ä»–ä¸å¿…è¦çš„åŠŸèƒ½

#### å…¶ä»–ä¾èµ–
- `reqwest`: åªå¯ç”¨ `json` å’Œ `rustls-tls`
- `tracing-subscriber`: åªå¯ç”¨å¿…è¦çš„åŠŸèƒ½
- `sled`: ç¦ç”¨é»˜è®¤ features
- `bincode`: ç¦ç”¨é»˜è®¤ features

### 3. æ„å»ºè„šæœ¬ä¼˜åŒ–

**é…ç½®ä½ç½®**ï¼š
- ä¸»è¦ä¼˜åŒ–é…ç½®åœ¨ `Cargo.toml` çš„ `[profile.release]` ä¸­
- é¢å¤–çš„ä¼˜åŒ–é€‰é¡¹é€šè¿‡ CI ä¸­çš„ `RUSTFLAGS` ç¯å¢ƒå˜é‡è®¾ç½®ï¼ˆåªå½±å“ release æ„å»ºï¼‰

**ä¼˜åŒ–é…ç½®è¯¦æƒ…**ï¼š

#### Cargo.toml ä¸­çš„é…ç½®
```toml
[profile.release]
opt-level = 'z'        # æœ€å°äºŒè¿›åˆ¶ä½“ç§¯ä¼˜åŒ–
lto = "thin"           # ä½¿ç”¨ thin LTOï¼ˆå¹³è¡¡ç¼–è¯‘æ—¶é—´å’Œä¼˜åŒ–æ•ˆæœï¼‰
codegen-units = 1      # é™åˆ¶å¹¶è¡Œä»£ç ç”Ÿæˆå•å…ƒ
panic = 'abort'        # Panic æ—¶ç«‹åˆ»ç»ˆæ­¢
debug = false          # å‡å°‘è°ƒè¯•ä¿¡æ¯
strip = true           # å‡å°‘ç¬¦å·ä¿¡æ¯
```

#### CI ä¸­çš„é¢å¤–ä¼˜åŒ–
åœ¨ GitLab CI çš„ release æ„å»ºä½œä¸šä¸­ï¼Œé€šè¿‡ `RUSTFLAGS` ç¯å¢ƒå˜é‡æ·»åŠ ï¼š
```yaml
variables:
  RUSTFLAGS: "-C link-dead-code=false"  # ç§»é™¤æœªä½¿ç”¨çš„ä»£ç 
```

**ä¸ºä»€ä¹ˆä¸åœ¨ `.cargo/config.toml` ä¸­è®¾ç½®å…¨å±€é…ç½®**ï¼š
- å…¨å±€é…ç½®ä¼šå½±å“æ‰€æœ‰æ„å»ºæ¨¡å¼ï¼ˆdevã€testã€clippy ç­‰ï¼‰
- å¯èƒ½å¯¼è‡´ LTO ä¸æŸäº› proc-macro ä¾èµ–çš„ `embed-bitcode=no` å†²çª
- é€šè¿‡ CI ä¸­çš„ `RUSTFLAGS` å¯ä»¥ç²¾ç¡®æ§åˆ¶ï¼Œåªå½±å“ release æ„å»º

## ğŸ“Š é¢„æœŸä¼˜åŒ–æ•ˆæœ

æ ¹æ®æ–‡ç« æ•°æ®ï¼Œé¢„æœŸä¼˜åŒ–æ•ˆæœï¼š

| ä¼˜åŒ–æ­¥éª¤ | é¢„æœŸä½“ç§¯å‡å°‘ |
|---------|------------|
| Release æ¨¡å¼ | ~80% |
| strip | ~45% |
| opt-level = 'z' | ~5% |
| LTO | ~20% |
| codegen-units = 1 | ~5% |
| panic = 'abort' | ~5% |
| ç¦ç”¨ä¸å¿…è¦çš„ features | ~30-50% |

**æ€»ä½“é¢„æœŸ**ï¼šä»åŸå§‹ä½“ç§¯å‡å°‘ **60-80%**

## ğŸš€ æ„å»ºå‘½ä»¤

### æ ‡å‡† Release æ„å»º
```bash
cargo build --release
```

### å¸¦ strip çš„æ„å»ºï¼ˆè¿›ä¸€æ­¥å‡å°ä½“ç§¯ï¼‰
```bash
cargo build --release
strip -s target/release/rust-edge-compute
```

### ä½¿ç”¨ UPX å‹ç¼©ï¼ˆå¯é€‰ï¼Œè¿›ä¸€æ­¥å‡å°ï¼‰
```bash
cargo build --release
strip -s target/release/rust-edge-compute
upx -9 target/release/rust-edge-compute
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Panic è¡Œä¸ºå˜åŒ–

å¯ç”¨ `panic = 'abort'` åï¼š
- âœ… å‡å°‘äºŒè¿›åˆ¶ä½“ç§¯
- âš ï¸ ç¦ç”¨ panic æ—¶çš„å †æ ˆå›æº¯
- âš ï¸ æ— æ³•è·å– panic æ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯

**å»ºè®®**ï¼š
- ç”Ÿäº§ç¯å¢ƒï¼šå¯ä»¥å¯ç”¨ä»¥å‡å°ä½“ç§¯
- å¼€å‘/è°ƒè¯•ç¯å¢ƒï¼šå»ºè®®ç¦ç”¨ä»¥ä¾¿è°ƒè¯•

### 2. ç¼–è¯‘æ—¶é—´

å¯ç”¨ LTO å’Œ `codegen-units = 1` åï¼š
- âš ï¸ ç¼–è¯‘æ—¶é—´ä¼šæ˜¾è‘—å¢åŠ ï¼ˆå¯èƒ½å¢åŠ  2-5 å€ï¼‰
- âœ… ä½†è¿è¡Œæ—¶æ€§èƒ½å’Œä½“ç§¯éƒ½ä¼šæ”¹å–„

**å»ºè®®**ï¼š
- CI/CD æ„å»ºï¼šä½¿ç”¨è¿™äº›ä¼˜åŒ–
- æœ¬åœ°å¼€å‘ï¼šå¯ä»¥ä½¿ç”¨ `dev` profile å¿«é€Ÿç¼–è¯‘

### 3. Features ç®¡ç†

åœ¨ç¦ç”¨ features æ—¶éœ€è¦æ³¨æ„ï¼š
- ç¡®ä¿åªç¦ç”¨çœŸæ­£ä¸éœ€è¦çš„åŠŸèƒ½
- æŸäº› features å¯èƒ½æ˜¯å…¶ä»–ä¾èµ–çš„é—´æ¥ä¾èµ–
- å»ºè®®é€æ­¥ç¦ç”¨å¹¶æµ‹è¯•

### 4. ä¾èµ–ä½“ç§¯

æŸäº›ä¾èµ–ï¼ˆå¦‚ Candle MLï¼‰æœ¬èº«ä½“ç§¯è¾ƒå¤§ï¼š
- Candle åº“ï¼šåŒ…å«å¤§é‡æ¨¡å‹æ¨ç†ä»£ç 
- PyO3ï¼šPython è§£é‡Šå™¨ç»‘å®š
- Wasmtimeï¼šWASM è¿è¡Œæ—¶

è¿™äº›ä¾èµ–çš„ä½“ç§¯ä¼˜åŒ–ç©ºé—´æœ‰é™ï¼Œä¸»è¦ä¼˜åŒ–æ–¹å‘ï¼š
- åªå¯ç”¨å¿…è¦çš„ features
- è€ƒè™‘æŒ‰éœ€åŠ è½½ï¼ˆåŠ¨æ€é“¾æ¥ï¼‰

## ğŸ”§ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨ Xargo è£å‰ª libstdï¼ˆé«˜çº§ï¼‰

å¦‚æœéœ€è¦è¿›ä¸€æ­¥å‡å°ä½“ç§¯ï¼Œå¯ä»¥ä½¿ç”¨ Xargo è£å‰ªæ ‡å‡†åº“ï¼š

```toml
# Xargo.toml
[dependencies]
std = { default-features = false, features = ["panic_immediate_abort"] }
```

ç„¶åä½¿ç”¨ `xargo build` æ„å»ºã€‚

**æ³¨æ„**ï¼šè¿™éœ€è¦é¢å¤–çš„å·¥å…·é“¾é…ç½®ï¼Œå¯èƒ½å½±å“å…¼å®¹æ€§ã€‚

### 2. åŠ¨æ€é“¾æ¥ï¼ˆå¯é€‰ï¼‰

å¯¹äºæŸäº›å¤§å‹ä¾èµ–ï¼Œå¯ä»¥è€ƒè™‘åŠ¨æ€é“¾æ¥ï¼š
- å‡å°‘å•ä¸ªäºŒè¿›åˆ¶ä½“ç§¯
- å¤šä¸ªç¨‹åºå¯ä»¥å…±äº«åº“
- ä½†éƒ¨ç½²æ—¶éœ€è¦åŒ…å«åŠ¨æ€åº“

### 3. æŒ‰éœ€åŠ è½½ Executor

å½“å‰è®¾è®¡å·²ç»æ”¯æŒæŒ‰éœ€åŠ è½½ executorï¼š
- ä½¿ç”¨ features æ§åˆ¶ç¼–è¯‘å“ªäº› executor
- åªç¼–è¯‘éœ€è¦çš„ executor å¯ä»¥æ˜¾è‘—å‡å°ä½“ç§¯

```bash
# åªç¼–è¯‘ C++ executor
cargo build --release --features cpp

# åªç¼–è¯‘ ML executor
cargo build --release --features ml

# ç¼–è¯‘æ‰€æœ‰ executor
cargo build --release --features full
```

## ğŸ“ˆ ä½“ç§¯å¯¹æ¯”

### ä¼˜åŒ–å‰ï¼ˆdev æ¨¡å¼ï¼‰
- ä½“ç§¯ï¼š~26.5MBï¼ˆç¤ºä¾‹ï¼‰
- åŒ…å«å¤§é‡è°ƒè¯•ä¿¡æ¯

### ä¼˜åŒ–åï¼ˆrelease + æ‰€æœ‰ä¼˜åŒ–ï¼‰
- é¢„æœŸä½“ç§¯ï¼š~1-2MBï¼ˆä¸»ç¨‹åºï¼‰
- å‡å°‘ï¼š~90%+

### å„ Executor ä½“ç§¯ä¼°ç®—
- C++ Executor: ~500KB-1MB
- ML Executor: ~2-5MBï¼ˆåŒ…å« Candle åº“ï¼‰
- Python Executor: ~1-2MBï¼ˆä¸åŒ…å« Python è§£é‡Šå™¨ï¼‰

## ğŸ¯ è¾¹ç¼˜ç«¯éƒ¨ç½²å»ºè®®

1. **æŒ‰éœ€ç¼–è¯‘**ï¼šåªç¼–è¯‘éœ€è¦çš„ executor
2. **ä½¿ç”¨ strip**ï¼šéƒ¨ç½²å‰æ‰§è¡Œ strip
3. **è€ƒè™‘ UPX**ï¼šå¦‚æœå­˜å‚¨ç©ºé—´éå¸¸æœ‰é™
4. **ç›‘æ§ä½“ç§¯**ï¼šå®šæœŸæ£€æŸ¥äºŒè¿›åˆ¶ä½“ç§¯å˜åŒ–
5. **æµ‹è¯•éªŒè¯**ï¼šç¡®ä¿ä¼˜åŒ–ååŠŸèƒ½æ­£å¸¸

## ğŸ“ å‚è€ƒèµ„æº

- [Aloxaf's Blog - ä¼˜åŒ– Rust ç¨‹åºç¼–è¯‘ä½“ç§¯](https://www.aloxaf.com/2018/09/reduce_rust_size/)
- [min-sized-rust](https://github.com/johnthagen/min-sized-rust)
- [Rust Performance Book](https://nnethercote.github.io/perf-book/)


